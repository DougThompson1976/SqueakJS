Object subclass: #JSObjectProxy	instanceVariableNames: ''	classVariableNames: ''	poolDictionaries: ''	category: 'JSBridge-Core'!!JSObjectProxy commentStamp: 'bf 11/20/2014 12:00' prior: 0!A JSObjectProxy is a proxy for JavaScript objects. It intercepts messages to look up named properties, and call them if they are functions. Arguments are converted from Squeak to JavaScript objects for nil, Booleans, SmallIntegers, Floats, Strings, Arrays, and Dictionaries. The result is converted back to Squeak objects for numbers and null/true/false, otherwise wrapped in a new JSObjectProxy. To add new properties, or access existing properties without calling them (if they are functions), use at:/at:put:. In addition, sending #new/#new:... creates an instance of that object, and #typeof returns the type as a string. There is a global proxy named JS to allow accessing global JavasScript objects."Call global function"JS alert: 'Squeak says Hello World!!'."Call function on global object"JS console log: 'Squeak says Hello World!!'."Modify DOM"((JS document getElementsByTagName: 'h1') at: 0)	at: 'innerHTML' put: 'Squeak said Hello World at ', Time now asString."Create new Object, add and retrieve property"| obj |obj := JS Object new.obj at: #someProp put: 42.obj someProp"Create a function and call it"| func |func := JS Function new: 'arg0' and: 'arg1' body: 'return arg0 + arg1'.func call: nil with: 3 and: 4."Create an object with a literal object property and a method and call it"| obj |obj := JS Object new.obj at: #myProp put: {#a -> 6. #b -> 7}.obj at: #myMethod put: (JS Function new: 'return this.myProp.a * this.myProp.b').obj myMethod"Inspect all properties in global navigator object"| object propNames propValues |object := JS navigator.propNames := JS Object keys: object.propValues := (0 to: propNames length - 1) collect: [:i |	(propNames at: i) -> (object at: (propNames at: i))].(propValues as: Dictionary) inspect!!JSObjectProxy methodsFor: 'accessing' stamp: 'bf 11/20/2014 00:38'!at: aString	"get a property"	| error |	<primitive: 117> #(JavaScriptPlugin primitiveAt 0 0) at: 1.	(error := self primGetError)		ifNotNil: [^ self error: error].	^ self primitiveFailed!at: aString put: anObject	"set a property"	| error |	<primitive: 117> #(JavaScriptPlugin primitiveAtPut 0 0) at: 1.	(error := self primGetError) ifNotNil: [		^ (error beginsWith: 'asJSArgument')			ifTrue: [self at: aString put: anObject asJSArgument]			ifFalse: [self error: error]].	^ self primitiveFailed!doesNotUnderstand: aMessage	"Call a function, or get/set an existing property. The function name / property name is the message selector up to the first colon. If the function name is 'new', create a new instance and call the constructor with args."	| error |	<primitive: 117> #(JavaScriptPlugin primitiveDoUnderstand 0 0) at: 1.	(error := self primGetError) ifNotNil: [		^ (error beginsWith: 'asJSArgument')			ifTrue: [self perform: aMessage selector				withArguments: aMessage arguments asJSArgument]			ifFalse: [self error: error]].	^ self primitiveFailed!printOn: aStream	[aStream nextPutAll: self asString]		ifError: [:err :rcvr | ^ super printOn: aStream].!asString	"Convert me to a string"	<primitive: 117> #(JavaScriptPlugin primitiveAsString 0 0) at: 1.	^ self primitiveFailed!asJSArgument	^ self!typeof	"Answer my jsObject's type (a string)"	<primitive: 117> #(JavaScriptPlugin primitiveTypeof 0 0) at: 1.	^ self primitiveFailed! !!JSObjectProxy methodsFor: 'private' stamp: 'bf 11/20/2014 00:38'!primGetError	<primitive: 117> #(JavaScriptPlugin primitiveGetError 0 0) at: 1.	^ nil! !!JSObjectProxy class methodsFor: 'instance creation' stamp: 'bf 11/20/2014 00:38'!new	self error: 'Use "JS Object new" to create a new JavaScript object'.! !!JSObjectProxy class methodsFor: 'class initialization' stamp: 'bf 11/21/2014 17:00'!initialize	"Create the JS global"	Smalltalk at: #JS put: self basicNew.	"If we have the plugin, show workspace"	[JS window] ifError: [:err :rcvr | ^self].	Smalltalk isMorphic		ifTrue: [self openExamples]		ifFalse: [[self openExamples] fork].!openExamples	Workspace new		contents: 'Besides running regular Squeak images, SqueakJS can directly use JavaScript. It can interact with the DOM, access JavaScript libraries, and use Smalltalk code to create an interactive HTML interface. Try these examples:', self examples;		openLabel: 'JSBridge'.!examples	| comment |	"Create symbols in advance"	('alert: console log: document getElementsByTagName: new:and:body: call:with:and: navigator Object keys: Function length'		findTokens: ' ') do: [:s | s asSymbol].	comment := self organization classComment asString.	^ comment copyFrom: (comment indexOf: $") to: comment size.! !!Object methodsFor: '*jsbridge-core' stamp: 'bf 11/25/2014 18:12'!asJSArgument	self error: 'Cannot convert ', self class name, ' to JavaScript'.! !!UndefinedObject methodsFor: '*jsbridge-core' stamp: 'bf 11/25/2014 18:12'!asJSArgument	"converted to JS null by plugin"	^self! !!Boolean methodsFor: '*jsbridge-core' stamp: 'bf 11/25/2014 18:12'!asJSArgument	"converted to JS true/false by plugin"	^self! !!SmallInteger methodsFor: '*jsbridge-core' stamp: 'bf 11/25/2014 18:12'!asJSArgument	"converted to JS number by plugin"	^self! !!Float methodsFor: '*jsbridge-core' stamp: 'bf 11/25/2014 18:12'!asJSArgument	"converted to JS number by plugin"	^self! !!Collection methodsFor: '*jsbridge-core' stamp: 'bf 11/25/2014 18:12'!asJSArgument	"converted to JS array by plugin"	| array i |	array := Array new: self size.	i := 0.	self do: [:each | array at: (i := i + 1) put: each asJSArgument].	^ array! !!Dictionary methodsFor: '*jsbridge-core' stamp: 'bf 11/25/2014 18:12'!asJSArgument	"converted to JS object by plugin"	| assocs i |	assocs := Array new: self size.	i := 0.	self associationsDo: [:a |		assocs at: (i := i + 1) put: a key asJSArgument -> a value asJSArgument].	^ assocs! !!String methodsFor: '*jsbridge-core' stamp: 'bf 11/25/2014 18:12'!asJSArgument	"converted to JS string by plugin"	self class isBytes ifTrue: [^self].	^super asJSArgument! !JSObjectProxy initialize!